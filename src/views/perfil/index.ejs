<%- include('../partials/header') %>

<div class="perfil-page">
  <div class="container">
    <div class="perfil-header">
      <div>
        <h1>Meu Perfil</h1>
        <p>Gerencie suas informações e reservas</p>
      </div>
      <a href="/perfil/configuracoes" class="btn-settings">
        <i class="fas fa-cog"></i> Configurações
      </a>
    </div>
    
    <% 
      const urlParams = new URLSearchParams(typeof window !== 'undefined' ? window.location.search : '');
      const successParam = urlParams.get('success');
      const errorParam = urlParams.get('error');
    %>
    
    <% if (typeof success === 'string' && success) { %>
      <div class="alert alert-success">
        <%= success %>
      </div>
    <% } %>
    
    <% if (typeof error === 'string' && error) { %>
      <div class="alert alert-error">
        <%= error %>
      </div>
    <% } %>
    
    <div class="perfil-grid">
      <!-- Informações do Usuário -->
      <div class="perfil-card">
        <div class="card-header-perfil">
          <h2><i class="fas fa-user-circle"></i> Informações Pessoais</h2>
          <button class="btn-icon" onclick="abrirModalPerfil()">
            <i class="fas fa-edit"></i>
          </button>
        </div>
        
        <div class="info-grid">
          <div class="info-item">
            <label>Nome Completo</label>
            <p><%= user.nome %></p>
          </div>
          
          <div class="info-item">
            <label>Email</label>
            <p><%= user.email %></p>
          </div>
          
          <% if (hospede) { %>
            <div class="info-item">
              <label>CPF</label>
              <p><%= hospede.CPF || 'Não informado' %></p>
            </div>
            
            <div class="info-item">
              <label>Telefone</label>
              <p><%= hospede.telefone || 'Não informado' %></p>
            </div>
            
            <div class="info-item">
              <label>Endereço</label>
              <p><%= hospede.endereco || 'Não informado' %></p>
            </div>
            
            <div class="info-item">
              <label>Data de Nascimento</label>
              <p><%= hospede.dataNascimento ? new Date(hospede.dataNascimento).toLocaleDateString('pt-BR') : 'Não informado' %></p>
            </div>
          <% } %>
          
          <div class="info-item">
            <label>Membro desde</label>
            <p><%= new Date(hospede.dataCadastro).toLocaleDateString('pt-BR') %></p>
          </div>
          
          <div class="info-item">
            <label>Tipo de Conta</label>
            <p><span class="badge-tipo <%= user.tipo %>"><%= user.tipo === 'admin' ? 'Administrador' : 'Cliente' %></span></p>
          </div>
        </div>
      </div>
      
      <!-- Minhas Reservas -->
      <div class="reservas-section">
        <h2><i class="fas fa-calendar-check"></i> Minhas Reservas</h2>
        
        <% if (reservas.length === 0) { %>
          <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <p>Você ainda não tem nenhuma reserva</p>
            <a href="/quartos" class="btn-primary">Ver Quartos Disponíveis</a>
          </div>
        <% } else { %>
          <div class="reservas-list">
            <% reservas.forEach(reserva => { %>
              <div class="reserva-card-perfil">
                <div class="reserva-header-perfil">
                  <div>
                    <h3>Quarto <%= reserva.quarto ? reserva.quarto.numero : 'N/A' %> - <%= reserva.quarto ? reserva.quarto.tipo : 'N/A' %></h3>
                    <p class="reserva-id">#<%= reserva._id.toString().slice(0, 8) %></p>
                  </div>
                  <span class="badge-status-reserva status-<%= reserva.status.toLowerCase() %>">
                    <%= reserva.status %>
                  </span>
                </div>
                 
                <div class="reserva-info-grid">
                  <div class="reserva-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                      <label>Check-in</label>
                      <p><%= new Date(reserva.checkIn).toLocaleDateString('pt-BR') %></p>
                    </div>
                  </div>
                  
                  <div class="reserva-info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                      <label>Check-out</label>
                      <p><%= new Date(reserva.checkOut).toLocaleDateString('pt-BR') %></p>
                    </div>
                  </div>
                  
                  <div class="reserva-info-item">
                    <i class="fas fa-users"></i>
                    <div>
                      <label>Hóspedes</label>
                      <p><%= reserva.numeroHospedes %> pessoa(s)</p>
                    </div>
                  </div>
                  
                  <div class="reserva-info-item">
                    <i class="fas fa-dollar-sign"></i>
                    <div>
                      <label>Valor Total</label>
                      <p class="valor-destaque">R$ <%= reserva.total.toFixed(2) %></p>
                    </div>
                  </div>
                  
                  <% if (reserva.pagamento) { %>
                    <div class="reserva-info-item">
                      <i class="fas fa-credit-card"></i>
                      <div>
                        <label>Pagamento</label>
                        <p><%= reserva.pagamento.metodoPagamento %></p>
                        <span class="badge-pagamento <%= reserva.pagamento.status.toLowerCase() %>">
                          <%= reserva.pagamento.status %>
                        </span>
                      </div>
                    </div>
                  <% } %>
                </div>
                
                <% if (reserva.status === 'Confirmada' || reserva.status === 'Pendente') { %>
                  <div class="reserva-acoes">
                    <form action="/perfil/cancelar-reserva/<%= reserva.id %>" method="POST" onsubmit="return confirm('Tem certeza que deseja cancelar esta reserva?')">
                      <button type="submit" class="btn-cancel">
                        <i class="fas fa-times-circle"></i> Cancelar Reserva
                      </button>
                    </form>
                  </div>
                <% } %>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Perfil -->
<div id="modalPerfil" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Editar Perfil</h3>
      <button class="modal-close" onclick="fecharModalPerfil()">&times;</button>
    </div>
    <form action="/perfil/atualizar" method="POST">
      <div class="form-group">
        <label for="nome">Nome Completo</label>
        <input type="text" id="nome" name="nome" value="<%= user.nome %>" required>
      </div>
      
      <div class="form-group">
        <label for="telefone">Telefone</label>
        <input type="text" id="telefone" name="telefone" value="<%= hospede ? hospede.telefone : '' %>" placeholder="(00) 00000-0000">
      </div>
      
      <div class="form-group">
        <label for="endereco">Endereço</label>
        <input type="text" id="endereco" name="endereco" value="<%= hospede ? hospede.endereco : '' %>">
      </div>
      
      <div class="form-group">
        <label for="dataNascimento">Data de Nascimento</label>
        <input type="date" id="dataNascimento" name="dataNascimento" value="<%= hospede && hospede.dataNascimento ? hospede.dataNascimento: '' %>">
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-outline" onclick="fecharModalPerfil()">Cancelar</button>
        <button type="submit" class="btn-primary">Salvar Alterações</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirModalPerfil() {
    document.getElementById('modalPerfil').style.display = 'flex';
  }
  
  function fecharModalPerfil() {
    document.getElementById('modalPerfil').style.display = 'none';
  }
  
  window.onclick = function(event) {
    const modal = document.getElementById('modalPerfil');
    if (event.target === modal) {
      fecharModalPerfil();
    }
  }
</script>

<%- include('../partials/footer') %>
